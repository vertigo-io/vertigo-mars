<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:vu="https://vertigo.io/thymeleaf/vertigo-ui" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{templates/mmcDetailLayout}">
<head>
<title>AI</title>
	<script th:src="@{/static/js/ai.js}"></script>
	<!-- maps -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@8.2.0/ol.min.css" type="text/css"/>
	<script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>
</head>
<body>
	<section layout:fragment="content-nav">
		<q-item tag="a" href="#files">Files</q-item>
		<template v-if="vueData.aiFileResponses.length > 0">
			<q-item tag="a" href="#infos">Informations</q-item>
			<q-item tag="a" href="#timeline">Timeline</q-item>
			<q-item tag="a" href="#map">Map</q-item>
			<q-item tag="a" href="#ask">Ask</q-item>
		</template>
	</section>
	<section layout:fragment="content">
		<vu:block id="files" title="Files" th:with="viewMode='edit'">
			<div class="row">
				<div class="col-xl-6 col-12">
					<vu:fileupload th:url="'@{/commons/upload}'" object="aiQuery" field="docUris" multiple componentId="aiFileUpload"/>
				</div>
			</div>
        </vu:block>			
		<template v-if="vueData.aiFileResponses.length > 0">
			<vu:block id="infos" title="Informations">
				<vu:include-data object="aiFileResponses" field="'*'" />
				<vu:cards list="aiFileResponses" componentId="fileCards" rowsPerPage="100" showMore="true" cardClass="col-xl-6 col-12" >
					<q-card-section>
	                    <div class="text-bold">{{item.fileName}}</div>
		            </q-card-section>
		            <q-separator></q-separator>
		            <template v-if="item.loading">
						<q-card-section class="q-pa-none">
		                   	<q-skeleton height="200px" square ><div class="text-center">Analyzing...</div></q-skeleton>
		            	</q-card-section>
		            </template>
		            <template v-else>
		            	<template v-if="item.date != null">
		            		<q-card-section>
                                <q-icon name="event" class="q-mr-xs" size="md"></q-icon>{{item.date}}
		                    </q-card-section>
			                <q-separator></q-separator>
		            	</template>
		            	
		            	<template v-if="item.address != null">
		            		<q-card-section>
                                <q-icon name="location_on" class="q-mr-xs" size="md"></q-icon>{{item.address}}
		                    </q-card-section>
			                <q-separator></q-separator>
		            	</template>
		            	
		            	<template v-if="item.tags != null">
                    		<q-card-section>
                                <q-icon name="label" class="q-mr-xs" size="md"></q-icon><q-chip v-for="tag in item.tags.split(';')" :label="tag"></q-chip>
                            </q-card-section>
                            <q-separator></q-separator>
                        </template>
                        
                        <template v-if="item.persons != null">
							<q-card-section>
								<q-icon name="person" class="q-mr-xs" size="md"></q-icon><q-chip v-for="person in item.persons.split(';')" :label="person"></q-chip>
							</q-card-section>
							<q-separator></q-separator>
		            	</template>
		            	
						<q-card-section>
	                        <div class="text-weight-bold" v-html="item.description"></div>
	                        
	                        <div :class="{'ellipsis': !item.expanded}" v-html="item.summary"></div>
	                        
	                        <q-btn color="grey" round flat dense
								:icon="item.expanded ? 'mdi-chevron-up' : 'mdi-chevron-down'"
								@click="item.expanded = !item.expanded" ></q-btn>
						</q-card-section>
					</template>
				</vu:cards>
			</vu:block>
			<vu:block id="timeline" title="Timeline">
				<div v-if="vueData.aiFileResponses.filter(f => f.date != null).length == 0" class="text-center">No timeline data</div>
				<q-timeline>
					<q-timeline-entry v-for="file in vueData.aiFileResponses.filter(e => e.date != null).sort((a,b) => a.date.localeCompare(b.date))"
										:title="file.fileName"
										:subtitle="file.date"
										:body="file.description"></q-timeline-entry>
				</q-timeline>
			</vu:block>
			<vu:block id="map" title="Map">
			    <div v-if="vueData.aiFileResponses.filter(f => f.gps != null).length == 0" class="text-center">No map data</div>
			    <div v-else>
			    	<v-map style="width:100%; height: 600px;" id="map_ol">
						<v-map-layer marker-color="#027BE3" :list="vueData.aiFileResponses.filter(f => f.gps != null)" field="gps" name-field="fileName" fit-on-data-update></v-map-layer>
					</v-map>
				</div>
			</vu:block>
			<vu:block id="ask" title="Ask a question on documents">
				<template v-if="vueData.chatOpened != true">
                    <q-btn @click="openChat(vueData.aiFileResponses.map(f => f.fileUri), r => {vueData.chatOpened=true})" label="Open chat" ></q-btn>
                </template>
				<template v-else>
                    <q-btn @click="vueData.chatOpened=false; vueData.chat=[]" label="Close chat" ></q-btn>
					<q-scroll-area style="height: calc(95vh - 300px);" ref="scroller">
						<q-chat-message v-for="msg in vueData.chat" :text="[msg.text]"
						                :sent="msg.type=='user'" :text-html="msg.type!='user'"
						                :avatar="msg.type=='user' ? 'https://cdn.quasar.dev/img/avatar1.jpg' : 'https://cdn.quasar.dev/img/avatar2.jpg'"></q-chat-message>
						<q-chat-message v-if="vueData.chatting" avatar="https://cdn.quasar.dev/img/avatar2.jpg"><q-spinner-dots size="2rem" /></q-chat-message>
					</q-scroll-area>
					<q-input filled v-model="vueData.aiQuery.prompt" placeholder="Entrez un message" ref="input"
					         :disable="vueData.chatting" :loading="vueData.chatting"
					         class="q-mt-md"
					         @keydown.enter.prevent="chat(vueData.aiQuery.prompt,
			                                              r => {
			                                                vueData.chat.push({text:r, type:'system'});
			                                                vueData.chatting=false;
			                                                $nextTick(() => {$refs.input.focus();});
			                                                } );
	                                                 vueData.chat.push({text:vueData.aiQuery.prompt, type:'user'});
		                                             vueData.aiQuery.prompt='';
		                                             vueData.chatting=true;"></q-input>
                </template>
			</vu:block>
		</template>
	</section>
</body>
</html>